<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Understanding identification in pogit from the ground up pt.&nbsp;2</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="identification_ch2_files/libs/clipboard/clipboard.min.js"></script>
<script src="identification_ch2_files/libs/quarto-html/quarto.js"></script>
<script src="identification_ch2_files/libs/quarto-html/popper.min.js"></script>
<script src="identification_ch2_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="identification_ch2_files/libs/quarto-html/anchor.min.js"></script>
<link href="identification_ch2_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="identification_ch2_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="identification_ch2_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="identification_ch2_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="identification_ch2_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Understanding identification in pogit from the ground up pt.&nbsp;2</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>Part 1 covered some first modifications of the most simple pogit in search of what breaks our model. As long as the data was normally distributed, everything sees fine unless one introduces nearly-perfect multicollinearity in the logit. This is of course no meaningful insight since we know this to break identification in any index.</p>
<p>In the real data, we also have identification issues even if the logit variables are few and barely correlated at all. So we must look elsewhereâ€¦</p>
<p>My other suspicion is that identification in the real data fails because there is a high concentration of data points for which the logit probability has sufficiently little curvature. My intuition was that this <strong>would create something like a multicollinearity problem</strong> in the rate product <span class="math inline">\(\mu_i \cdot \pi_i\)</span> for the thinned poisson rate.</p>
<!-- add notes here -->
<p>This chapter will dive into the dgp-related questions that could give rise to this phenomenon.</p>
<p>The second derivative of the logistic is</p>
<p><span class="math display">\[\frac{d^2}{dx^2} \text{logistic}(x) = -\frac{e^x(e^x - 1)}{(e^x + 1)^3}\]</span></p>
<p>which tends to 0 when the index (which measure the <em>log odds</em>) <span class="math inline">\(x\)</span> goes to either <span class="math inline">\(-\infty\)</span> or <span class="math inline">\(\infty\)</span> and is zero at <span class="math inline">\(x=0\)</span>. For these values, the curvature is small and the function therefore approximately linear. This corresponds to probabilities approaching 0 or 1 respectively, or those very close to 0.5.</p>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'dplyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    filter, lag</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
<div class="cell-output-display">
<p><img src="identification_ch2_files/figure-html/unnamed-chunk-1-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Let us start by simulating the same data as in pt.&nbsp;1 and have a look at how the <span class="math inline">\(\pi_i\)</span> values, which are the thinning probabilities, are distributed.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># data simulation as in Ch1</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1999</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mvtnorm)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>rho <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>S <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, rho,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>              rho, <span class="dv">1</span>), <span class="dv">2</span>, <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>x_z <span class="ot">&lt;-</span> <span class="fu">rmvnorm</span>(n, <span class="at">sigma =</span> S)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> x_z[,<span class="dv">1</span>] </span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> x_z[,<span class="dv">2</span>] </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="co"># poisson intercept</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># x in poisson</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>log_mu <span class="ot">&lt;-</span> alpha <span class="sc">+</span> beta <span class="sc">*</span> (x <span class="sc">-</span> <span class="fu">mean</span>(x)) <span class="co"># poisson rate</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>ystar <span class="ot">&lt;-</span> <span class="fu">rpois</span>(n, <span class="fu">exp</span>(log_mu)) <span class="co"># unobserved count</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>gamma <span class="ot">&lt;-</span> (<span class="sc">-</span><span class="fl">0.5</span>) <span class="co"># logit intercept</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>delta <span class="ot">&lt;-</span> <span class="fl">1.2</span> <span class="co"># excluded z in logit</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>kappa <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="co"># x in logit</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>logit_pi <span class="ot">&lt;-</span> gamma <span class="sc">+</span> delta <span class="sc">*</span> (z <span class="sc">-</span> <span class="fu">mean</span>(z)) <span class="sc">+</span> kappa <span class="sc">*</span> (x <span class="sc">-</span> <span class="fu">mean</span>(x)) <span class="co"># logit probability</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="at">size =</span> ystar, <span class="at">prob =</span> <span class="fu">plogis</span>(logit_pi)) <span class="co"># observed (thinned) count</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>true_params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">alpha =</span> alpha, <span class="at">beta =</span> beta, <span class="at">gamma =</span> gamma, <span class="at">delta =</span> delta, <span class="at">kappa =</span> kappa)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We saw that under this DGP, there are no model problems and sampling is efficient.</p>
<p>Here our thinning probabilities are distributed as follows:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>x_seq <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">min</span>(logit_pi), <span class="fu">max</span>(logit_pi), <span class="at">length.out =</span> <span class="dv">1000</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>d2_logistic_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">x =</span> x_seq, <span class="at">d2_logistic_v =</span> <span class="fu">d2_logistic</span>(x_seq), <span class="at">logit_pi =</span> logit_pi)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>d2_logistic_df <span class="sc">|&gt;</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_histogram</span>(<span class="fu">aes</span>(<span class="at">x =</span> logit_pi), <span class="at">bins =</span> <span class="dv">30</span>, <span class="at">fill =</span> <span class="st">"grey"</span>) <span class="sc">+</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> x, <span class="at">y =</span> d2_logistic_v<span class="sc">*</span><span class="dv">300</span>), <span class="at">color =</span> <span class="st">"black"</span>) <span class="sc">+</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Distribution of thinning probabilities (log odds)"</span>,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>             <span class="at">x =</span> <span class="st">"log odds"</span>,</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>             <span class="at">y =</span> <span class="st">"count"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="identification_ch2_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This implies the following distribution of thinning probabilities:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(<span class="fu">plogis</span>(logit_pi))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="identification_ch2_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>As a heuristic metric, let us consider the (empirical) expected curvature of the the logistic function at the thinning probabilities.</p>
<p><span class="math display">\[\frac{1}{n} \sum_{i=1}^n -\frac{e^{\pi_i}(e^{\pi_i} - 1)}{(e^{\pi_i} + 1)^3}\]</span></p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="fu">d2_logistic</span>(logit_pi))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.02017655</code></pre>
</div>
</div>
<p>Letâ€™s now make this more ugly: We modify the DGP such that the thinning probabilities in our samples are more concentrated around zero and 1 (the sampling chains in for the real data draw mostly ones - although the chains do not mix wellâ€¦).</p>
<p>I will first leave x nicely normally distributed, and just crank up its influence on the logit part of the model to push the thinning probabilities towards 0 and 1.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>kappa_new <span class="ot">&lt;-</span> <span class="dv">3</span> <span class="co"># x in logit</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Creating new thinning probabilities:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>logit_pi_new <span class="ot">&lt;-</span> gamma <span class="sc">+</span> delta <span class="sc">*</span> (z <span class="sc">-</span> <span class="fu">mean</span>(z)) <span class="sc">+</span> kappa_new <span class="sc">*</span> (x <span class="sc">-</span> <span class="fu">mean</span>(x))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>probs <span class="ot">&lt;-</span> <span class="fu">plogis</span>(logit_pi_new)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(probs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="identification_ch2_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>and has a much lower expected curvature:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="fu">d2_logistic</span>(logit_pi_new))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.005464826</code></pre>
</div>
</div>
<p>Let us now compare estimation. I ignore the censoring which matters only for computational matters but not the core of the identification problem.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>This is cmdstanr version 0.6.1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- CmdStanR documentation and vignettes: mc-stan.org/cmdstanr</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- CmdStan path: /Users/lasse/.cmdstan/cmdstan-2.33.0</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- CmdStan version: 2.33.0</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
A newer version of CmdStan is available. See ?install_cmdstan() to install it.
To disable this check set option or environment variable CMDSTANR_NO_VER_CHECK=TRUE.</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load model</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>stan_model <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"thinned_poisson_w_priors_x_logit.stan"</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># original data</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> n, <span class="at">y =</span> y, <span class="at">x =</span> x, <span class="at">z =</span> z, <span class="at">alpha_prior_var =</span> <span class="fl">0.1</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co"># fit</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> stan_model<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> dat, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">parallel_chains =</span> <span class="dv">4</span>, <span class="at">refresh =</span> <span class="dv">500</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Exception: poisson_lpmf: Rate parameter[12] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpzVkqyV/model-2ac950f7c166.stan', line 32, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Exception: poisson_lpmf: Rate parameter[12] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpzVkqyV/model-2ac950f7c166.stan', line 32, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Exception: poisson_lpmf: Rate parameter[12] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpzVkqyV/model-2ac950f7c166.stan', line 32, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Exception: poisson_lpmf: Rate parameter[29] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpzVkqyV/model-2ac950f7c166.stan', line 32, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Exception: poisson_lpmf: Rate parameter[4] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpzVkqyV/model-2ac950f7c166.stan', line 32, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Exception: poisson_lpmf: Rate parameter[112] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpzVkqyV/model-2ac950f7c166.stan', line 32, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 1 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 2 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 3 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 4 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 4 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 1 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 3 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 2.0 seconds.
Chain 4 finished in 2.0 seconds.
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 2.1 seconds.
Chain 3 finished in 2.1 seconds.

All 4 chains finished successfully.
Mean chain execution time: 2.1 seconds.
Total execution time: 2.3 seconds.</code></pre>
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>This is bayesplot version 1.10.0</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- Online documentation and vignettes at mc-stan.org/bayesplot</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- bayesplot theme set to bayesplot::theme_default()</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>   * Does _not_ affect other ggplot2 plots</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>   * See ?bayesplot_theme_set for details on theme setting</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_diagnostics</span>(fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]</code></pre>
</div>
<div class="cell-output-display">
<p><img src="identification_ch2_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
[[2]]</code></pre>
</div>
<div class="cell-output-display">
<p><img src="identification_ch2_files/figure-html/unnamed-chunk-11-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
[[3]]</code></pre>
</div>
<div class="cell-output-display">
<p><img src="identification_ch2_files/figure-html/unnamed-chunk-11-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Now we generate data with the new DGP and estimate the model again.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co"># new data</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>y_new <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="at">size =</span> ystar, <span class="at">prob =</span> <span class="fu">plogis</span>(logit_pi_new))</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>dat_new <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> n, <span class="at">y =</span> y_new, <span class="at">x =</span> x, <span class="at">z =</span> z, <span class="at">alpha_prior_var =</span> <span class="fl">0.1</span>)</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="co"># fit</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>fit_new <span class="ot">&lt;-</span> stan_model<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> dat_new, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">parallel_chains =</span> <span class="dv">4</span>, <span class="at">refresh =</span> <span class="dv">500</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Exception: poisson_lpmf: Rate parameter[4] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpzVkqyV/model-2ac950f7c166.stan', line 32, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Exception: poisson_lpmf: Rate parameter[144] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpzVkqyV/model-2ac950f7c166.stan', line 32, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Exception: poisson_lpmf: Rate parameter[17] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpzVkqyV/model-2ac950f7c166.stan', line 32, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 2 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 3 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 3 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 1.8 seconds.
Chain 3 finished in 1.8 seconds.
Chain 1 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 4 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 4 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 11.5 seconds.
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 12.5 seconds.

All 4 chains finished successfully.
Mean chain execution time: 6.9 seconds.
Total execution time: 12.6 seconds.</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_diagnostics</span>(fit_new)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]</code></pre>
</div>
<div class="cell-output-display">
<p><img src="identification_ch2_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
[[2]]</code></pre>
</div>
<div class="cell-output-display">
<p><img src="identification_ch2_files/figure-html/unnamed-chunk-12-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
[[3]]</code></pre>
</div>
<div class="cell-output-display">
<p><img src="identification_ch2_files/figure-html/unnamed-chunk-12-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This picture confirms the problem! The posteriors for x are not identified on either side of the model, and one chain is stuck in a completely different region with a higher beta and lower kappa. This is reflected by poor convergence diagnostics:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>fit_new<span class="sc">$</span><span class="fu">summary</span>() <span class="sc">|&gt;</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>    knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 11%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 6%">
<col style="width: 11%">
<col style="width: 11%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">median</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">mad</th>
<th style="text-align: right;">q5</th>
<th style="text-align: right;">q95</th>
<th style="text-align: right;">rhat</th>
<th style="text-align: right;">ess_bulk</th>
<th style="text-align: right;">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">lp__</td>
<td style="text-align: right;">1210.04</td>
<td style="text-align: right;">1206.63</td>
<td style="text-align: right;">22.55</td>
<td style="text-align: right;">33.34</td>
<td style="text-align: right;">1185.29</td>
<td style="text-align: right;">1234.19</td>
<td style="text-align: right;">1.73</td>
<td style="text-align: right;">6.13</td>
<td style="text-align: right;">166.32</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha</td>
<td style="text-align: right;">0.45</td>
<td style="text-align: right;">0.47</td>
<td style="text-align: right;">0.11</td>
<td style="text-align: right;">0.11</td>
<td style="text-align: right;">0.25</td>
<td style="text-align: right;">0.61</td>
<td style="text-align: right;">1.35</td>
<td style="text-align: right;">9.34</td>
<td style="text-align: right;">127.84</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beta</td>
<td style="text-align: right;">2.75</td>
<td style="text-align: right;">2.27</td>
<td style="text-align: right;">1.80</td>
<td style="text-align: right;">2.06</td>
<td style="text-align: right;">0.93</td>
<td style="text-align: right;">5.02</td>
<td style="text-align: right;">1.74</td>
<td style="text-align: right;">6.13</td>
<td style="text-align: right;">158.49</td>
</tr>
<tr class="even">
<td style="text-align: left;">gamma</td>
<td style="text-align: right;">-0.18</td>
<td style="text-align: right;">-0.15</td>
<td style="text-align: right;">0.31</td>
<td style="text-align: right;">0.39</td>
<td style="text-align: right;">-0.66</td>
<td style="text-align: right;">0.27</td>
<td style="text-align: right;">1.65</td>
<td style="text-align: right;">6.52</td>
<td style="text-align: right;">178.68</td>
</tr>
<tr class="odd">
<td style="text-align: left;">delta</td>
<td style="text-align: right;">0.80</td>
<td style="text-align: right;">0.49</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.75</td>
<td style="text-align: right;">0.03</td>
<td style="text-align: right;">1.82</td>
<td style="text-align: right;">1.73</td>
<td style="text-align: right;">6.14</td>
<td style="text-align: right;">138.76</td>
</tr>
<tr class="even">
<td style="text-align: left;">kappa</td>
<td style="text-align: right;">-0.01</td>
<td style="text-align: right;">0.02</td>
<td style="text-align: right;">3.57</td>
<td style="text-align: right;">5.23</td>
<td style="text-align: right;">-4.02</td>
<td style="text-align: right;">3.96</td>
<td style="text-align: right;">1.73</td>
<td style="text-align: right;">6.13</td>
<td style="text-align: right;">165.78</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We can also push this further to the extreme: Letâ€™s make the thinning probabilities even more concentrated around 0 and 1.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>kappa_new_2 <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="co"># x in logit</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>logit_pi_new_2 <span class="ot">&lt;-</span> gamma <span class="sc">+</span> delta <span class="sc">*</span> (z <span class="sc">-</span> <span class="fu">mean</span>(z)) <span class="sc">+</span> kappa_new_2 <span class="sc">*</span> (x <span class="sc">-</span> <span class="fu">mean</span>(x))</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>probs_new_2 <span class="ot">&lt;-</span> <span class="fu">plogis</span>(logit_pi_new_2)</span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(probs_new_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="identification_ch2_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Average curvature is now even lower:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(<span class="fu">d2_logistic</span>(logit_pi_new_2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.000186123</code></pre>
</div>
</div>
<ol type="1">
<li>Estimating this should be even worse:</li>
</ol>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>y_new_2 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="at">size =</span> ystar, <span class="at">prob =</span> <span class="fu">plogis</span>(logit_pi_new_2))</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>dat_new_2 <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> n, <span class="at">y =</span> y_new_2, <span class="at">x =</span> x, <span class="at">z =</span> z, <span class="at">alpha_prior_var =</span> <span class="fl">0.1</span>)</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>fit_new_2 <span class="ot">&lt;-</span> stan_model<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> dat_new_2, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">parallel_chains =</span> <span class="dv">4</span>, <span class="at">refresh =</span> <span class="dv">500</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Exception: poisson_lpmf: Rate parameter[380] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpzVkqyV/model-2ac950f7c166.stan', line 32, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Exception: poisson_lpmf: Rate parameter[380] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpzVkqyV/model-2ac950f7c166.stan', line 32, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Exception: poisson_lpmf: Rate parameter[328] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpzVkqyV/model-2ac950f7c166.stan', line 32, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Exception: poisson_lpmf: Rate parameter[328] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpzVkqyV/model-2ac950f7c166.stan', line 32, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Exception: poisson_lpmf: Rate parameter[77] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpzVkqyV/model-2ac950f7c166.stan', line 32, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Exception: poisson_lpmf: Rate parameter[328] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpzVkqyV/model-2ac950f7c166.stan', line 32, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Exception: poisson_lpmf: Rate parameter[4] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpzVkqyV/model-2ac950f7c166.stan', line 32, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 1 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 2 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 3 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 2 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 3 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 4 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 1.7 seconds.
Chain 3 finished in 1.7 seconds.
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 1.8 seconds.
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 1.9 seconds.

All 4 chains finished successfully.
Mean chain execution time: 1.8 seconds.
Total execution time: 2.1 seconds.</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>fit_new_2<span class="sc">$</span><span class="fu">summary</span>() <span class="sc">|&gt;</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a>    knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 12%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 6%">
<col style="width: 6%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 6%">
<col style="width: 12%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">median</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">mad</th>
<th style="text-align: right;">q5</th>
<th style="text-align: right;">q95</th>
<th style="text-align: right;">rhat</th>
<th style="text-align: right;">ess_bulk</th>
<th style="text-align: right;">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">lp__</td>
<td style="text-align: right;">1479.61</td>
<td style="text-align: right;">1479.93</td>
<td style="text-align: right;">1.62</td>
<td style="text-align: right;">1.43</td>
<td style="text-align: right;">1476.52</td>
<td style="text-align: right;">1481.58</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1805.60</td>
<td style="text-align: right;">2215.53</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha</td>
<td style="text-align: right;">0.58</td>
<td style="text-align: right;">0.58</td>
<td style="text-align: right;">0.04</td>
<td style="text-align: right;">0.05</td>
<td style="text-align: right;">0.51</td>
<td style="text-align: right;">0.66</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1718.81</td>
<td style="text-align: right;">2001.99</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beta</td>
<td style="text-align: right;">0.94</td>
<td style="text-align: right;">0.94</td>
<td style="text-align: right;">0.03</td>
<td style="text-align: right;">0.03</td>
<td style="text-align: right;">0.89</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1828.89</td>
<td style="text-align: right;">2123.80</td>
</tr>
<tr class="even">
<td style="text-align: left;">gamma</td>
<td style="text-align: right;">-0.62</td>
<td style="text-align: right;">-0.63</td>
<td style="text-align: right;">0.20</td>
<td style="text-align: right;">0.20</td>
<td style="text-align: right;">-0.94</td>
<td style="text-align: right;">-0.29</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2371.80</td>
<td style="text-align: right;">2735.88</td>
</tr>
<tr class="odd">
<td style="text-align: left;">delta</td>
<td style="text-align: right;">1.14</td>
<td style="text-align: right;">1.13</td>
<td style="text-align: right;">0.30</td>
<td style="text-align: right;">0.31</td>
<td style="text-align: right;">0.66</td>
<td style="text-align: right;">1.66</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2432.41</td>
<td style="text-align: right;">2479.99</td>
</tr>
<tr class="even">
<td style="text-align: left;">kappa</td>
<td style="text-align: right;">9.89</td>
<td style="text-align: right;">9.81</td>
<td style="text-align: right;">1.17</td>
<td style="text-align: right;">1.18</td>
<td style="text-align: right;">8.10</td>
<td style="text-align: right;">11.90</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">2405.18</td>
<td style="text-align: right;">2602.19</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_diagnostics</span>(fit_new_2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]</code></pre>
</div>
<div class="cell-output-display">
<p><img src="identification_ch2_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
[[2]]</code></pre>
</div>
<div class="cell-output-display">
<p><img src="identification_ch2_files/figure-html/unnamed-chunk-17-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
[[3]]</code></pre>
</div>
<div class="cell-output-display">
<p><img src="identification_ch2_files/figure-html/unnamed-chunk-17-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>For some very odd reason whenever this is run by commamd this gives very different results than the output from rendering the html fileâ€¦ Because of different initializations? I tried this about 2 times and it is consistenty different. It is possible that for even extremer values of <span class="math inline">\(\kappa\)</span> the extremism might reduce stochastic variability in a way that makes the model converge better again, this I have to figure out as well. But it doesnt make sense that the results depend from where the code is run(!). I need to fix this [#todo:].</p>
</div>
</div>
<p>I think that this is the phenomenon behind the identification issues in the real data. Identification there fails because the chains mostly draw <em>values that imply thinning probabilities of close to 1</em> where the logistic function is approximately linear.</p>
<p>In other words, the model breaks down if thinning is <strong>not substantially happening</strong> for a sufficiently large number of data points.</p>
<p>In the next chapter, I will think about what this implies about the problem we are trying to model and how one could fix it (and what a fix would even mean).</p>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>