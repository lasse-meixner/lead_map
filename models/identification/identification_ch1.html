<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Understanding identification in pogit from the ground up</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="identification_ch1_files/libs/clipboard/clipboard.min.js"></script>
<script src="identification_ch1_files/libs/quarto-html/quarto.js"></script>
<script src="identification_ch1_files/libs/quarto-html/popper.min.js"></script>
<script src="identification_ch1_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="identification_ch1_files/libs/quarto-html/anchor.min.js"></script>
<link href="identification_ch1_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="identification_ch1_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="identification_ch1_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="identification_ch1_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="identification_ch1_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Understanding identification in pogit from the ground up</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p>We ignore the issue of censoring for now since we know how to deal with that and focus on the identification of the parameters in the Poisson-logit model.</p>
<section id="baseline" class="level3">
<h3 class="anchored" data-anchor-id="baseline">Baseline</h3>
<p>Let us start with with two correlated variables, <span class="math inline">\(x\)</span> and <span class="math inline">\(z\)</span>, where <span class="math inline">\(x\)</span> is a poisson regressor and <span class="math inline">\(z\)</span> is an exclusion restriction used in the logit part of the model. This is the learn-bayes example:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1999</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mvtnorm)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>rho <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>S <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, rho,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>              rho, <span class="dv">1</span>), <span class="dv">2</span>, <span class="dv">2</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>x_z <span class="ot">&lt;-</span> <span class="fu">rmvnorm</span>(n, <span class="at">sigma =</span> S)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> x_z[,<span class="dv">1</span>] </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> x_z[,<span class="dv">2</span>] </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>alpha <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>beta <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>log_mu <span class="ot">&lt;-</span> alpha <span class="sc">+</span> beta <span class="sc">*</span> (x <span class="sc">-</span> <span class="fu">mean</span>(x))</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>ystar <span class="ot">&lt;-</span> <span class="fu">rpois</span>(n, <span class="fu">exp</span>(log_mu))</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>gamma <span class="ot">&lt;-</span> (<span class="sc">-</span><span class="fl">0.5</span>)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>delta <span class="ot">&lt;-</span> <span class="fl">1.2</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>logit_pi <span class="ot">&lt;-</span> gamma <span class="sc">+</span> delta <span class="sc">*</span> (z <span class="sc">-</span> <span class="fu">mean</span>(z))</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="at">size =</span> ystar, <span class="at">prob =</span> <span class="fu">plogis</span>(logit_pi))</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>true_params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">alpha =</span> alpha, <span class="at">beta =</span> beta, <span class="at">gamma =</span> gamma, <span class="at">delta =</span> delta)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>This model is identified:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>This is cmdstanr version 0.6.1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- CmdStanR documentation and vignettes: mc-stan.org/cmdstanr</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- CmdStan path: /Users/lasse/.cmdstan/cmdstan-2.33.0</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- CmdStan version: 2.33.0</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
A newer version of CmdStan is available. See ?install_cmdstan() to install it.
To disable this check set option or environment variable CMDSTANR_NO_VER_CHECK=TRUE.</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>thinned_poisson <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"thinned_poisson.stan"</span>) <span class="co"># takes int N, and vectors y, x, z</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N =</span> n, <span class="at">y =</span> y, <span class="at">x =</span> x, <span class="at">z =</span> z)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> thinned_poisson<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> dat, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">parallel_chains =</span> <span class="dv">4</span>, <span class="at">refresh =</span> <span class="dv">500</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Exception: poisson_lpmf: Rate parameter[13] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpXghOZF/model-11e3479eb6c90.stan', line 27, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Exception: poisson_lpmf: Rate parameter[13] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpXghOZF/model-11e3479eb6c90.stan', line 27, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Exception: poisson_lpmf: Rate parameter[13] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpXghOZF/model-11e3479eb6c90.stan', line 27, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Exception: poisson_lpmf: Rate parameter[13] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpXghOZF/model-11e3479eb6c90.stan', line 27, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Exception: poisson_lpmf: Rate parameter[13] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpXghOZF/model-11e3479eb6c90.stan', line 27, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Exception: poisson_lpmf: Rate parameter[13] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpXghOZF/model-11e3479eb6c90.stan', line 27, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Exception: poisson_lpmf: Rate parameter[13] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpXghOZF/model-11e3479eb6c90.stan', line 27, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Exception: poisson_lpmf: Rate parameter[4] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpXghOZF/model-11e3479eb6c90.stan', line 27, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Exception: poisson_lpmf: Rate parameter[19] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpXghOZF/model-11e3479eb6c90.stan', line 27, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 1 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 2 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 3 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 4 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 2 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 3 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 4 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 1.7 seconds.
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 1.7 seconds.
Chain 3 finished in 1.8 seconds.
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 1.9 seconds.

All 4 chains finished successfully.
Mean chain execution time: 1.8 seconds.
Total execution time: 2.0 seconds.</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>fit<span class="sc">$</span><span class="fu">summary</span>() <span class="sc">|&gt;</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>    knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 13%">
<col style="width: 8%">
<col style="width: 10%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 7%">
<col style="width: 13%">
<col style="width: 13%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">median</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">mad</th>
<th style="text-align: right;">q5</th>
<th style="text-align: right;">q95</th>
<th style="text-align: right;">rhat</th>
<th style="text-align: right;">ess_bulk</th>
<th style="text-align: right;">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">lp__</td>
<td style="text-align: right;">42.17</td>
<td style="text-align: right;">42.51</td>
<td style="text-align: right;">1.43</td>
<td style="text-align: right;">1.22</td>
<td style="text-align: right;">39.37</td>
<td style="text-align: right;">43.86</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1455.00</td>
<td style="text-align: right;">1946.70</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha</td>
<td style="text-align: right;">0.39</td>
<td style="text-align: right;">0.38</td>
<td style="text-align: right;">0.12</td>
<td style="text-align: right;">0.12</td>
<td style="text-align: right;">0.21</td>
<td style="text-align: right;">0.59</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">949.00</td>
<td style="text-align: right;">858.89</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beta</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.04</td>
<td style="text-align: right;">0.04</td>
<td style="text-align: right;">0.94</td>
<td style="text-align: right;">1.06</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1806.12</td>
<td style="text-align: right;">2085.94</td>
</tr>
<tr class="even">
<td style="text-align: left;">gamma</td>
<td style="text-align: right;">-0.29</td>
<td style="text-align: right;">-0.28</td>
<td style="text-align: right;">0.23</td>
<td style="text-align: right;">0.23</td>
<td style="text-align: right;">-0.67</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">997.20</td>
<td style="text-align: right;">949.37</td>
</tr>
<tr class="odd">
<td style="text-align: left;">delta</td>
<td style="text-align: right;">1.35</td>
<td style="text-align: right;">1.34</td>
<td style="text-align: right;">0.19</td>
<td style="text-align: right;">0.19</td>
<td style="text-align: right;">1.05</td>
<td style="text-align: right;">1.69</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1199.85</td>
<td style="text-align: right;">1482.26</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>This agrees with the true parameters. The sampling is also efficient - the effective sample size is large and the Rhat is close to 1.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>This is bayesplot version 1.10.0</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- Online documentation and vignettes at mc-stan.org/bayesplot</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- bayesplot theme set to bayesplot::theme_default()</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>   * Does _not_ affect other ggplot2 plots</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>   * See ?bayesplot_theme_set for details on theme setting</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="co"># auxiliary function to plot diagnostics (posterior draws, trace plots)</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>plot_diagnostics <span class="ot">&lt;-</span> <span class="cf">function</span>(fit){</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    draws <span class="ot">&lt;-</span> fit<span class="sc">$</span><span class="fu">draws</span>(<span class="at">format =</span> <span class="st">"draws_df"</span>) <span class="sc">|&gt;</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>        dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>lp__)</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>    fig1 <span class="ot">&lt;-</span> <span class="fu">mcmc_areas</span>(draws, <span class="at">prob =</span> <span class="fl">0.9</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Posterior draws"</span>) <span class="sc">+</span></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">theme_minimal</span>()</span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>    fig2 <span class="ot">&lt;-</span> <span class="fu">mcmc_trace</span>(draws) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Trace plots"</span>) <span class="sc">+</span> <span class="fu">theme_minimal</span>()</span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>    fig3 <span class="ot">&lt;-</span> <span class="fu">mcmc_rank_ecdf</span>(draws, <span class="at">prob =</span> <span class="fl">0.99</span>, <span class="at">plot_diff =</span> <span class="cn">TRUE</span>) <span class="sc">+</span> <span class="fu">ggtitle</span>(<span class="st">"Cumulative rank plots (difference)"</span>) <span class="sc">+</span></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>()</span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># potentially add plot for divergent transitions</span></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(fig1, fig2, fig3)</span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_diagnostics</span>(fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]</code></pre>
</div>
<div class="cell-output-display">
<p><img src="identification_ch1_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
[[2]]</code></pre>
</div>
<div class="cell-output-display">
<p><img src="identification_ch1_files/figure-html/unnamed-chunk-4-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
[[3]]</code></pre>
</div>
<div class="cell-output-display">
<p><img src="identification_ch1_files/figure-html/unnamed-chunk-4-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The parameters in the logit model are more or less right, but very imprecise. There are two sources of this: 1) the excluded variable <span class="math inline">\(z\)</span> is correlated with the poisson regressor <span class="math inline">\(x\)</span> 2) the intercepts are not well identified.</p>
<p>Let us try fixing priors on both intercepts. I fix a prior on the logit intercept in accordance with the suggestion from the <em>Statistical Rethinking</em> playlist (Frank’s recommendation). Since the logit takes the linear <span class="math inline">\(\gamma + \delta z\)</span> as predictions for the the log-odds, if these values range from <span class="math inline">\((-4,4)\)</span>, they essentially cover the entire probability spectrum from 0 to 1.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sample</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>intercepts <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(n<span class="sc">*</span><span class="dv">10</span>, <span class="dv">0</span>, <span class="fl">1.5</span>)</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>p  <span class="ot">&lt;-</span> <span class="fu">plogis</span>(intercepts)</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="co"># plot density and histogram</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(p, <span class="at">breaks =</span> <span class="dv">20</span>, <span class="at">freq =</span> <span class="cn">FALSE</span>, <span class="at">main =</span> <span class="fu">expression</span>(<span class="fu">paste</span>(<span class="st">"logit(p) = "</span>, alpha)), <span class="at">xlab =</span> <span class="st">"p"</span>)</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="fu">density</span>(p), <span class="at">col =</span> <span class="st">"red"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="identification_ch1_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>This gives a uniform-like distribution for the prior probabilities, so I will use this as a very weak prior for <span class="math inline">\(\gamma\)</span>.</p>
<p>Not on the Poisson side, I pretend to have information about the mean <span class="math inline">\(\alpha\)</span> based on domain knowledge. In our data, we have national averages from NHANES about the prevalence of elevated blood lead counts. I simulate this by adding a weak prior to the true value of <span class="math inline">\(\alpha\)</span>.</p>
<p>The new model looks as follows:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>thinned_poisson_prior <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"thinned_poisson_w_priors.stan"</span>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>ld: warning: duplicate -rpath '/Users/lasse/.cmdstan/cmdstan-2.33.0/stan/lib/stan_math/lib/tbb' ignored</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>thinned_poisson_prior<span class="sc">$</span><span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>data {
  int&lt;lower=0&gt; N; 
  array[N] int&lt;lower=0&gt; y; 
  vector[N] x; 
  vector[N] z;
  real alpha_prior_var;
}

transformed data {
  real x_bar = mean(x); 
  real z_bar = mean(z); 
  vector[N] x_demeaned = (x - x_bar); 
  vector[N] z_demeaned = (z - z_bar);
}

parameters {
  real alpha;
  real beta;
  real gamma;
  real delta;
}

model {
  // priors
  alpha ~ normal(0.5, alpha_prior_var);
  gamma ~ normal(0, 1.5);
  // model
  vector[N] mu = exp(alpha + beta * x_demeaned);
  vector[N] pie = inv_logit(gamma + delta * z_demeaned); // (inverse of logit is logistic function 1/(1+exp(-x)))
  vector[N] lambda = mu .* pie; // elementwise product
  y ~ poisson(lambda); 
}</code></pre>
</div>
</div>
<p>Sampling with priors:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add alpha prior variance to data</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>dat<span class="sc">$</span>alpha_prior_var <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>fit_prior <span class="ot">&lt;-</span> thinned_poisson_prior<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> dat, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">parallel_chains =</span> <span class="dv">4</span>, <span class="at">refresh =</span> <span class="dv">500</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Exception: poisson_lpmf: Rate parameter[328] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpvfwHdQ/model-1333a193b2cbc.stan', line 31, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Exception: poisson_lpmf: Rate parameter[328] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpvfwHdQ/model-1333a193b2cbc.stan', line 31, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Exception: poisson_lpmf: Rate parameter[13] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpvfwHdQ/model-1333a193b2cbc.stan', line 31, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Exception: poisson_lpmf: Rate parameter[13] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpvfwHdQ/model-1333a193b2cbc.stan', line 31, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Exception: poisson_lpmf: Rate parameter[7] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpvfwHdQ/model-1333a193b2cbc.stan', line 31, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Exception: poisson_lpmf: Rate parameter[25] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpvfwHdQ/model-1333a193b2cbc.stan', line 31, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 1 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 2 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 3 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 4 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 2 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 3 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 4 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 1.8 seconds.
Chain 3 finished in 1.8 seconds.
Chain 4 finished in 1.7 seconds.
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 1.9 seconds.

All 4 chains finished successfully.
Mean chain execution time: 1.8 seconds.
Total execution time: 1.9 seconds.</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>fit_prior<span class="sc">$</span><span class="fu">summary</span>() <span class="sc">|&gt;</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>    knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 13%">
<col style="width: 8%">
<col style="width: 10%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 7%">
<col style="width: 13%">
<col style="width: 13%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">median</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">mad</th>
<th style="text-align: right;">q5</th>
<th style="text-align: right;">q95</th>
<th style="text-align: right;">rhat</th>
<th style="text-align: right;">ess_bulk</th>
<th style="text-align: right;">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">lp__</td>
<td style="text-align: right;">42.12</td>
<td style="text-align: right;">42.43</td>
<td style="text-align: right;">1.46</td>
<td style="text-align: right;">1.23</td>
<td style="text-align: right;">39.41</td>
<td style="text-align: right;">43.84</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1508.50</td>
<td style="text-align: right;">2066.22</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha</td>
<td style="text-align: right;">0.38</td>
<td style="text-align: right;">0.37</td>
<td style="text-align: right;">0.11</td>
<td style="text-align: right;">0.11</td>
<td style="text-align: right;">0.20</td>
<td style="text-align: right;">0.58</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1131.56</td>
<td style="text-align: right;">1169.24</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beta</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">0.03</td>
<td style="text-align: right;">0.03</td>
<td style="text-align: right;">0.95</td>
<td style="text-align: right;">1.06</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1658.87</td>
<td style="text-align: right;">2138.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">gamma</td>
<td style="text-align: right;">-0.26</td>
<td style="text-align: right;">-0.26</td>
<td style="text-align: right;">0.22</td>
<td style="text-align: right;">0.22</td>
<td style="text-align: right;">-0.64</td>
<td style="text-align: right;">0.10</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1212.47</td>
<td style="text-align: right;">1266.16</td>
</tr>
<tr class="odd">
<td style="text-align: left;">delta</td>
<td style="text-align: right;">1.37</td>
<td style="text-align: right;">1.37</td>
<td style="text-align: right;">0.19</td>
<td style="text-align: right;">0.20</td>
<td style="text-align: right;">1.06</td>
<td style="text-align: right;">1.69</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1325.65</td>
<td style="text-align: right;">1837.46</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Does it make things more precise?</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_diagnostics</span>(fit_prior)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]</code></pre>
</div>
<div class="cell-output-display">
<p><img src="identification_ch1_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
[[2]]</code></pre>
</div>
<div class="cell-output-display">
<p><img src="identification_ch1_files/figure-html/unnamed-chunk-8-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
[[3]]</code></pre>
</div>
<div class="cell-output-display">
<p><img src="identification_ch1_files/figure-html/unnamed-chunk-8-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The posterior distribution, although efficiently sampled, looks essentially identical. The priors seem to have little effect for the precision on the parameters on the logit side.</p>
</section>
<section id="adding-x-to-the-logit" class="level3">
<h3 class="anchored" data-anchor-id="adding-x-to-the-logit">Adding x to the logit</h3>
<p>Now, let us add the poisson regressor <span class="math inline">\(x\)</span> to the logit part of the model and see if including it on both sides messes up identification.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="co"># re-simulate data</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a>kappa <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>logit_pi <span class="ot">&lt;-</span> gamma <span class="sc">+</span> delta <span class="sc">*</span> (z <span class="sc">-</span> <span class="fu">mean</span>(z)) <span class="sc">+</span> kappa <span class="sc">*</span> (x <span class="sc">-</span> <span class="fu">mean</span>(x)) <span class="co"># NEW!</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="at">size =</span> ystar, <span class="at">prob =</span> <span class="fu">plogis</span>(logit_pi)) <span class="co"># NEW!</span></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>true_params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">alpha =</span> alpha, <span class="at">beta =</span> beta, <span class="at">gamma =</span> gamma, <span class="at">delta =</span> delta, <span class="at">kappa =</span> kappa) <span class="co"># NEW</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>In the STAN code we add the poisson regressor <span class="math inline">\(x\)</span> to the logit part of the model:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>thinned_poisson_x_priors <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"thinned_poisson_w_priors_x_logit.stan"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>ld: warning: duplicate -rpath '/Users/lasse/.cmdstan/cmdstan-2.33.0/stan/lib/stan_math/lib/tbb' ignored</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sample</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>fit_x_prior <span class="ot">&lt;-</span> thinned_poisson_x_priors<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> dat, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">parallel_chains =</span> <span class="dv">4</span>, <span class="at">refresh =</span> <span class="dv">500</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Exception: poisson_lpmf: Rate parameter[804] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpvfwHdQ/model-1333a76e0a577.stan', line 32, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Exception: poisson_lpmf: Rate parameter[804] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpvfwHdQ/model-1333a76e0a577.stan', line 32, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Exception: poisson_lpmf: Rate parameter[19] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpvfwHdQ/model-1333a76e0a577.stan', line 32, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Exception: poisson_lpmf: Rate parameter[42] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpvfwHdQ/model-1333a76e0a577.stan', line 32, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Exception: poisson_lpmf: Rate parameter[1] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpvfwHdQ/model-1333a76e0a577.stan', line 32, column 2 to column 22)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 1 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 2 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 3 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 4 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 2 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 4 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 3 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 2.9 seconds.
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 3.0 seconds.
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 3.2 seconds.
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 finished in 3.3 seconds.

All 4 chains finished successfully.
Mean chain execution time: 3.1 seconds.
Total execution time: 3.4 seconds.</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a>fit_x_prior<span class="sc">$</span><span class="fu">summary</span>() <span class="sc">|&gt;</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>    knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 13%">
<col style="width: 8%">
<col style="width: 10%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 7%">
<col style="width: 13%">
<col style="width: 13%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">median</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">mad</th>
<th style="text-align: right;">q5</th>
<th style="text-align: right;">q95</th>
<th style="text-align: right;">rhat</th>
<th style="text-align: right;">ess_bulk</th>
<th style="text-align: right;">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">lp__</td>
<td style="text-align: right;">42.16</td>
<td style="text-align: right;">42.44</td>
<td style="text-align: right;">1.48</td>
<td style="text-align: right;">1.35</td>
<td style="text-align: right;">39.32</td>
<td style="text-align: right;">44.03</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1706.85</td>
<td style="text-align: right;">2239.85</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha</td>
<td style="text-align: right;">0.48</td>
<td style="text-align: right;">0.46</td>
<td style="text-align: right;">0.17</td>
<td style="text-align: right;">0.16</td>
<td style="text-align: right;">0.24</td>
<td style="text-align: right;">0.77</td>
<td style="text-align: right;">1.01</td>
<td style="text-align: right;">900.50</td>
<td style="text-align: right;">1087.20</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beta</td>
<td style="text-align: right;">0.94</td>
<td style="text-align: right;">0.95</td>
<td style="text-align: right;">0.08</td>
<td style="text-align: right;">0.07</td>
<td style="text-align: right;">0.81</td>
<td style="text-align: right;">1.06</td>
<td style="text-align: right;">1.01</td>
<td style="text-align: right;">921.46</td>
<td style="text-align: right;">1167.12</td>
</tr>
<tr class="even">
<td style="text-align: left;">gamma</td>
<td style="text-align: right;">-0.47</td>
<td style="text-align: right;">-0.46</td>
<td style="text-align: right;">0.32</td>
<td style="text-align: right;">0.31</td>
<td style="text-align: right;">-1.00</td>
<td style="text-align: right;">0.03</td>
<td style="text-align: right;">1.01</td>
<td style="text-align: right;">899.60</td>
<td style="text-align: right;">1084.15</td>
</tr>
<tr class="odd">
<td style="text-align: left;">delta</td>
<td style="text-align: right;">1.28</td>
<td style="text-align: right;">1.28</td>
<td style="text-align: right;">0.19</td>
<td style="text-align: right;">0.19</td>
<td style="text-align: right;">0.98</td>
<td style="text-align: right;">1.62</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">1206.19</td>
<td style="text-align: right;">1353.36</td>
</tr>
<tr class="even">
<td style="text-align: left;">kappa</td>
<td style="text-align: right;">0.14</td>
<td style="text-align: right;">0.15</td>
<td style="text-align: right;">0.17</td>
<td style="text-align: right;">0.18</td>
<td style="text-align: right;">-0.14</td>
<td style="text-align: right;">0.43</td>
<td style="text-align: right;">1.00</td>
<td style="text-align: right;">995.75</td>
<td style="text-align: right;">1434.31</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Convergence is still good!</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_diagnostics</span>(fit_x_prior)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]</code></pre>
</div>
<div class="cell-output-display">
<p><img src="identification_ch1_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
[[2]]</code></pre>
</div>
<div class="cell-output-display">
<p><img src="identification_ch1_files/figure-html/unnamed-chunk-11-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
[[3]]</code></pre>
</div>
<div class="cell-output-display">
<p><img src="identification_ch1_files/figure-html/unnamed-chunk-11-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>In our data, sampling of the posteriors of the poisson parameters breaks.</p>
</section>
<section id="suppression" class="level3">
<h3 class="anchored" data-anchor-id="suppression">Suppression</h3>
<p>Is the issue with our data then just that the data does not vary enough that the non-linearities in the model can find these distributions?</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="co"># suppress data based on 70% threshold (0 is not suppressed though)</span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>threshold <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">quantile</span>(y, <span class="fl">0.7</span>)[[<span class="dv">1</span>]])</span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>y_suppressed <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(y <span class="sc">&lt;=</span> threshold, <span class="fu">ifelse</span>(y <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"s"</span>, <span class="dv">0</span>), y)</span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>is_suppressed <span class="ot">&lt;-</span> y_suppressed <span class="sc">==</span> <span class="st">"s"</span></span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a><span class="co"># demean x and z</span></span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a>x_demeaned <span class="ot">&lt;-</span> x <span class="sc">-</span> <span class="fu">mean</span>(x)</span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a>z_demeaned <span class="ot">&lt;-</span> z <span class="sc">-</span> <span class="fu">mean</span>(z)</span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-10"><a href="#cb154-10" aria-hidden="true" tabindex="-1"></a>dat_suppressed <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N_obs =</span> <span class="fu">as.integer</span>(n<span class="sc">-</span><span class="fu">sum</span>(is_suppressed)),</span>
<span id="cb154-11"><a href="#cb154-11" aria-hidden="true" tabindex="-1"></a>                       <span class="at">N_cens =</span> <span class="fu">as.integer</span>(<span class="fu">sum</span>(is_suppressed)),</span>
<span id="cb154-12"><a href="#cb154-12" aria-hidden="true" tabindex="-1"></a>                       <span class="at">y_obs =</span> y[<span class="sc">!</span>is_suppressed],</span>
<span id="cb154-13"><a href="#cb154-13" aria-hidden="true" tabindex="-1"></a>                       <span class="at">threshold =</span> threshold,</span>
<span id="cb154-14"><a href="#cb154-14" aria-hidden="true" tabindex="-1"></a>                       <span class="at">x_obs =</span> x_demeaned[<span class="sc">!</span>is_suppressed],</span>
<span id="cb154-15"><a href="#cb154-15" aria-hidden="true" tabindex="-1"></a>                       <span class="at">x_cens =</span> x_demeaned[is_suppressed],</span>
<span id="cb154-16"><a href="#cb154-16" aria-hidden="true" tabindex="-1"></a>                       <span class="at">z_obs =</span> z_demeaned[<span class="sc">!</span>is_suppressed],</span>
<span id="cb154-17"><a href="#cb154-17" aria-hidden="true" tabindex="-1"></a>                       <span class="at">z_cens =</span> z_demeaned[is_suppressed],</span>
<span id="cb154-18"><a href="#cb154-18" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alpha_prior_var =</span> <span class="fl">0.5</span>)</span>
<span id="cb154-19"><a href="#cb154-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-20"><a href="#cb154-20" aria-hidden="true" tabindex="-1"></a>thinned_poisson_suppressed <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"thinned_poisson_w_p_x_sup.stan"</span>)</span>
<span id="cb154-21"><a href="#cb154-21" aria-hidden="true" tabindex="-1"></a>fit_suppressed <span class="ot">&lt;-</span> thinned_poisson_suppressed<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> dat_suppressed, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">parallel_chains =</span> <span class="dv">4</span>, <span class="at">refresh =</span> <span class="dv">500</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Exception: poisson_lpmf: Rate parameter[4] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpufJdCR/model-122bf5ec37597.stan', line 31, column 2 to column 30)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 4 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 1 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 3 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 4 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 3 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 2 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 4.1 seconds.
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 4.3 seconds.
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 finished in 4.5 seconds.
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 4.7 seconds.

All 4 chains finished successfully.
Mean chain execution time: 4.4 seconds.
Total execution time: 4.8 seconds.</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a>fit_suppressed<span class="sc">$</span><span class="fu">summary</span>() <span class="sc">|&gt;</span></span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>    knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 12%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 7%">
<col style="width: 12%">
<col style="width: 12%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">median</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">mad</th>
<th style="text-align: right;">q5</th>
<th style="text-align: right;">q95</th>
<th style="text-align: right;">rhat</th>
<th style="text-align: right;">ess_bulk</th>
<th style="text-align: right;">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">lp__</td>
<td style="text-align: right;">366.25</td>
<td style="text-align: right;">366.53</td>
<td style="text-align: right;">1.52</td>
<td style="text-align: right;">1.38</td>
<td style="text-align: right;">363.38</td>
<td style="text-align: right;">368.18</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1542.22</td>
<td style="text-align: right;">2427.58</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha</td>
<td style="text-align: right;">0.36</td>
<td style="text-align: right;">0.35</td>
<td style="text-align: right;">0.13</td>
<td style="text-align: right;">0.13</td>
<td style="text-align: right;">0.15</td>
<td style="text-align: right;">0.58</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">996.04</td>
<td style="text-align: right;">1314.27</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beta</td>
<td style="text-align: right;">1.05</td>
<td style="text-align: right;">1.05</td>
<td style="text-align: right;">0.06</td>
<td style="text-align: right;">0.06</td>
<td style="text-align: right;">0.95</td>
<td style="text-align: right;">1.14</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1030.56</td>
<td style="text-align: right;">1291.12</td>
</tr>
<tr class="even">
<td style="text-align: left;">gamma</td>
<td style="text-align: right;">-0.04</td>
<td style="text-align: right;">-0.04</td>
<td style="text-align: right;">0.31</td>
<td style="text-align: right;">0.31</td>
<td style="text-align: right;">-0.55</td>
<td style="text-align: right;">0.48</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1041.71</td>
<td style="text-align: right;">1467.05</td>
</tr>
<tr class="odd">
<td style="text-align: left;">delta</td>
<td style="text-align: right;">1.30</td>
<td style="text-align: right;">1.29</td>
<td style="text-align: right;">0.20</td>
<td style="text-align: right;">0.20</td>
<td style="text-align: right;">0.97</td>
<td style="text-align: right;">1.65</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1342.41</td>
<td style="text-align: right;">1845.56</td>
</tr>
<tr class="even">
<td style="text-align: left;">kappa</td>
<td style="text-align: right;">0.29</td>
<td style="text-align: right;">0.30</td>
<td style="text-align: right;">0.16</td>
<td style="text-align: right;">0.16</td>
<td style="text-align: right;">0.02</td>
<td style="text-align: right;">0.55</td>
<td style="text-align: right;">1</td>
<td style="text-align: right;">1318.54</td>
<td style="text-align: right;">1780.63</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>true_params</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>alpha  beta gamma delta kappa 
  0.5   1.0  -0.5   1.2   0.5 </code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb165-1"><a href="#cb165-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_diagnostics</span>(fit_suppressed)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]</code></pre>
</div>
<div class="cell-output-display">
<p><img src="identification_ch1_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
[[2]]</code></pre>
</div>
<div class="cell-output-display">
<p><img src="identification_ch1_files/figure-html/unnamed-chunk-14-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
[[3]]</code></pre>
</div>
<div class="cell-output-display">
<p><img src="identification_ch1_files/figure-html/unnamed-chunk-14-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Censoring clearly reduces the information contained in the data and thereby increases the posterior uncertainty. Except the intercept on gamma, the parameters are however estimates more or less correct (centered around the true values). There are no sampling problems, the chains explore the posterior efficiently as can be seen by Rhat convergence values and the traces.</p>
</section>
<section id="including-more-correlation" class="level3">
<h3 class="anchored" data-anchor-id="including-more-correlation">Including more correlation</h3>
<p>My final hunch is that the real issue comes when variables to highly intercorrelated amongst themselves. Let’s add another variable <span class="math inline">\(w\)</span> to the mix: First, we let it be super highly correlated with <span class="math inline">\(z\)</span> only, then with <span class="math inline">\(x\)</span>.</p>
<p><em>Intuitively, I imagine that things should break down when variables are very correlated on intervals of the covariate space on which the poisson and logit are <strong>less curved</strong>. So for the logit this should be for the values of</em> <span class="math inline">\(z\)</span> and <span class="math inline">\(w\)</span> where the logit is close to 0.5… This might be a diagnostic?</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb169-1"><a href="#cb169-1" aria-hidden="true" tabindex="-1"></a><span class="co"># re-simulate data</span></span>
<span id="cb169-2"><a href="#cb169-2" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb169-3"><a href="#cb169-3" aria-hidden="true" tabindex="-1"></a>rho_high <span class="ot">&lt;-</span> <span class="fl">0.9</span></span>
<span id="cb169-4"><a href="#cb169-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb169-5"><a href="#cb169-5" aria-hidden="true" tabindex="-1"></a>S <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, rho, <span class="dv">0</span>,</span>
<span id="cb169-6"><a href="#cb169-6" aria-hidden="true" tabindex="-1"></a>              rho, <span class="dv">1</span>, rho_high,</span>
<span id="cb169-7"><a href="#cb169-7" aria-hidden="true" tabindex="-1"></a>              <span class="dv">0</span>, rho_high, <span class="dv">1</span>), <span class="dv">3</span>, <span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb169-8"><a href="#cb169-8" aria-hidden="true" tabindex="-1"></a>D <span class="ot">&lt;-</span> <span class="fu">rmvnorm</span>(n, <span class="at">sigma =</span> S)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in rmvnorm(n, sigma = S): sigma is numerically not positive
semidefinite</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb171-1"><a href="#cb171-1" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> D[,<span class="dv">1</span>]</span>
<span id="cb171-2"><a href="#cb171-2" aria-hidden="true" tabindex="-1"></a>z <span class="ot">&lt;-</span> D[,<span class="dv">2</span>]</span>
<span id="cb171-3"><a href="#cb171-3" aria-hidden="true" tabindex="-1"></a>w <span class="ot">&lt;-</span> D[,<span class="dv">3</span>]</span>
<span id="cb171-4"><a href="#cb171-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-5"><a href="#cb171-5" aria-hidden="true" tabindex="-1"></a><span class="co"># all parameters as before</span></span>
<span id="cb171-6"><a href="#cb171-6" aria-hidden="true" tabindex="-1"></a>omega_p <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">1</span> <span class="co"># NEW</span></span>
<span id="cb171-7"><a href="#cb171-7" aria-hidden="true" tabindex="-1"></a>omega_l <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="co"># NEW</span></span>
<span id="cb171-8"><a href="#cb171-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-9"><a href="#cb171-9" aria-hidden="true" tabindex="-1"></a>log_mu <span class="ot">&lt;-</span> alpha <span class="sc">+</span> beta <span class="sc">*</span> (x <span class="sc">-</span> <span class="fu">mean</span>(x)) <span class="sc">+</span> omega_p <span class="sc">*</span> (w <span class="sc">-</span> <span class="fu">mean</span>(w)) <span class="co"># NEW</span></span>
<span id="cb171-10"><a href="#cb171-10" aria-hidden="true" tabindex="-1"></a>ystar <span class="ot">&lt;-</span> <span class="fu">rpois</span>(n, <span class="fu">exp</span>(log_mu))</span>
<span id="cb171-11"><a href="#cb171-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-12"><a href="#cb171-12" aria-hidden="true" tabindex="-1"></a>logit_pi <span class="ot">&lt;-</span> gamma <span class="sc">+</span> delta <span class="sc">*</span> (z <span class="sc">-</span> <span class="fu">mean</span>(z)) <span class="sc">+</span> kappa <span class="sc">*</span> (x <span class="sc">-</span> <span class="fu">mean</span>(x)) <span class="sc">+</span> omega_l <span class="sc">*</span> (w <span class="sc">-</span> <span class="fu">mean</span>(w)) <span class="co"># NEW</span></span>
<span id="cb171-13"><a href="#cb171-13" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(n, <span class="at">size =</span> ystar, <span class="at">prob =</span> <span class="fu">plogis</span>(logit_pi))</span>
<span id="cb171-14"><a href="#cb171-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb171-15"><a href="#cb171-15" aria-hidden="true" tabindex="-1"></a>true_params <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="at">alpha =</span> alpha, <span class="at">beta =</span> beta, <span class="at">gamma =</span> gamma, <span class="at">delta =</span> delta, <span class="at">kappa =</span> kappa, <span class="at">omega_p =</span> omega_p, <span class="at">omega_l =</span> omega_l)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We again suppress the data as before:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb172-1"><a href="#cb172-1" aria-hidden="true" tabindex="-1"></a>threshold <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(<span class="fu">quantile</span>(y, <span class="fl">0.7</span>)[[<span class="dv">1</span>]])</span>
<span id="cb172-2"><a href="#cb172-2" aria-hidden="true" tabindex="-1"></a>y_suppressed <span class="ot">&lt;-</span> <span class="fu">ifelse</span>(y <span class="sc">&lt;=</span> threshold, <span class="fu">ifelse</span>(y <span class="sc">&gt;</span> <span class="dv">0</span>, <span class="st">"s"</span>, <span class="dv">0</span>), y)</span>
<span id="cb172-3"><a href="#cb172-3" aria-hidden="true" tabindex="-1"></a>is_suppressed <span class="ot">&lt;-</span> y_suppressed <span class="sc">==</span> <span class="st">"s"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We now need a STAN model that can handle arrays.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb173-1"><a href="#cb173-1" aria-hidden="true" tabindex="-1"></a>thinned_poisson_multiple <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"thinned_poisson_w_p_xw_sup.stan"</span>)</span>
<span id="cb173-2"><a href="#cb173-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-3"><a href="#cb173-3" aria-hidden="true" tabindex="-1"></a><span class="co"># prepare data</span></span>
<span id="cb173-4"><a href="#cb173-4" aria-hidden="true" tabindex="-1"></a>x_demeaned <span class="ot">&lt;-</span> x <span class="sc">-</span> <span class="fu">mean</span>(x)</span>
<span id="cb173-5"><a href="#cb173-5" aria-hidden="true" tabindex="-1"></a>z_demeaned <span class="ot">&lt;-</span> z <span class="sc">-</span> <span class="fu">mean</span>(z)</span>
<span id="cb173-6"><a href="#cb173-6" aria-hidden="true" tabindex="-1"></a>w_demeaned <span class="ot">&lt;-</span> w <span class="sc">-</span> <span class="fu">mean</span>(w)</span>
<span id="cb173-7"><a href="#cb173-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-8"><a href="#cb173-8" aria-hidden="true" tabindex="-1"></a>dat_suppressed <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N_obs =</span> <span class="fu">as.integer</span>(n<span class="sc">-</span><span class="fu">sum</span>(is_suppressed)),</span>
<span id="cb173-9"><a href="#cb173-9" aria-hidden="true" tabindex="-1"></a>                       <span class="at">N_cens =</span> <span class="fu">as.integer</span>(<span class="fu">sum</span>(is_suppressed)),</span>
<span id="cb173-10"><a href="#cb173-10" aria-hidden="true" tabindex="-1"></a>                       <span class="at">y_obs =</span> y[<span class="sc">!</span>is_suppressed],</span>
<span id="cb173-11"><a href="#cb173-11" aria-hidden="true" tabindex="-1"></a>                       <span class="at">threshold =</span> threshold,</span>
<span id="cb173-12"><a href="#cb173-12" aria-hidden="true" tabindex="-1"></a>                       <span class="at">x_obs =</span> x_demeaned[<span class="sc">!</span>is_suppressed],</span>
<span id="cb173-13"><a href="#cb173-13" aria-hidden="true" tabindex="-1"></a>                       <span class="at">x_cens =</span> x_demeaned[is_suppressed],</span>
<span id="cb173-14"><a href="#cb173-14" aria-hidden="true" tabindex="-1"></a>                       <span class="at">z_obs =</span> z_demeaned[<span class="sc">!</span>is_suppressed],</span>
<span id="cb173-15"><a href="#cb173-15" aria-hidden="true" tabindex="-1"></a>                       <span class="at">z_cens =</span> z_demeaned[is_suppressed],</span>
<span id="cb173-16"><a href="#cb173-16" aria-hidden="true" tabindex="-1"></a>                       <span class="at">w_obs =</span> w_demeaned[<span class="sc">!</span>is_suppressed],</span>
<span id="cb173-17"><a href="#cb173-17" aria-hidden="true" tabindex="-1"></a>                       <span class="at">w_cens =</span> w_demeaned[is_suppressed],</span>
<span id="cb173-18"><a href="#cb173-18" aria-hidden="true" tabindex="-1"></a>                       <span class="at">alpha_prior_var =</span> <span class="fl">0.5</span>)</span>
<span id="cb173-19"><a href="#cb173-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-20"><a href="#cb173-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb173-21"><a href="#cb173-21" aria-hidden="true" tabindex="-1"></a>fit_suppressed_multiple <span class="ot">&lt;-</span> thinned_poisson_multiple<span class="sc">$</span><span class="fu">sample</span>(<span class="at">data =</span> dat_suppressed, <span class="at">chains =</span> <span class="dv">4</span>, <span class="at">parallel_chains =</span> <span class="dv">4</span>, <span class="at">refresh =</span> <span class="dv">500</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Exception: poisson_lpmf: Rate parameter[20] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpufJdCR/model-122bf2c272ae3.stan', line 35, column 2 to column 30)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Exception: poisson_lpmf: Rate parameter[362] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpufJdCR/model-122bf2c272ae3.stan', line 35, column 2 to column 30)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Exception: poisson_lpmf: Rate parameter[49] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpufJdCR/model-122bf2c272ae3.stan', line 35, column 2 to column 30)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Informational Message: The current Metropolis proposal is about to be rejected because of the following issue:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Exception: poisson_lpmf: Rate parameter[20] is nan, but must be nonnegative! (in '/var/folders/yx/_8fch6cj6w5cfvy2xlfjrsyw0000gn/T/RtmpufJdCR/model-122bf2c272ae3.stan', line 35, column 2 to column 30)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 If this warning occurs sporadically, such as for highly constrained variable types like covariance matrices, then the sampler is fine,</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 but if this warning occurs often then your model may be either severely ill-conditioned or misspecified.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 1 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 2 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 4 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 3 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 1 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 4 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 3 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 199.7 seconds.
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 201.9 seconds.
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 203.4 seconds.
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 finished in 204.9 seconds.

All 4 chains finished successfully.
Mean chain execution time: 202.5 seconds.
Total execution time: 205.0 seconds.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: 3792 of 4000 (95.0%) transitions hit the maximum treedepth limit of 10.
See https://mc-stan.org/misc/warnings for details.</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb199"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb199-1"><a href="#cb199-1" aria-hidden="true" tabindex="-1"></a>fit_suppressed_multiple<span class="sc">$</span><span class="fu">summary</span>() <span class="sc">|&gt;</span></span>
<span id="cb199-2"><a href="#cb199-2" aria-hidden="true" tabindex="-1"></a>    knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 11%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 8%">
<col style="width: 8%">
<col style="width: 10%">
<col style="width: 10%">
<col style="width: 6%">
<col style="width: 11%">
<col style="width: 11%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">median</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">mad</th>
<th style="text-align: right;">q5</th>
<th style="text-align: right;">q95</th>
<th style="text-align: right;">rhat</th>
<th style="text-align: right;">ess_bulk</th>
<th style="text-align: right;">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">lp__</td>
<td style="text-align: right;">1183.69</td>
<td style="text-align: right;">1183.94</td>
<td style="text-align: right;">1.54</td>
<td style="text-align: right;">1.39</td>
<td style="text-align: right;">1180.79</td>
<td style="text-align: right;">1185.67</td>
<td style="text-align: right;">1.07</td>
<td style="text-align: right;">50.55</td>
<td style="text-align: right;">72.14</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha</td>
<td style="text-align: right;">0.11</td>
<td style="text-align: right;">-0.02</td>
<td style="text-align: right;">0.33</td>
<td style="text-align: right;">0.19</td>
<td style="text-align: right;">-0.24</td>
<td style="text-align: right;">0.72</td>
<td style="text-align: right;">1.61</td>
<td style="text-align: right;">6.89</td>
<td style="text-align: right;">11.10</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beta</td>
<td style="text-align: right;">1.77</td>
<td style="text-align: right;">1.99</td>
<td style="text-align: right;">0.47</td>
<td style="text-align: right;">0.13</td>
<td style="text-align: right;">0.95</td>
<td style="text-align: right;">2.16</td>
<td style="text-align: right;">1.66</td>
<td style="text-align: right;">6.49</td>
<td style="text-align: right;">11.25</td>
</tr>
<tr class="even">
<td style="text-align: left;">gamma</td>
<td style="text-align: right;">0.25</td>
<td style="text-align: right;">0.48</td>
<td style="text-align: right;">0.65</td>
<td style="text-align: right;">0.41</td>
<td style="text-align: right;">-0.93</td>
<td style="text-align: right;">1.02</td>
<td style="text-align: right;">1.66</td>
<td style="text-align: right;">6.78</td>
<td style="text-align: right;">18.31</td>
</tr>
<tr class="odd">
<td style="text-align: left;">delta</td>
<td style="text-align: right;">119.72</td>
<td style="text-align: right;">102.42</td>
<td style="text-align: right;">295.97</td>
<td style="text-align: right;">410.89</td>
<td style="text-align: right;">-342.49</td>
<td style="text-align: right;">545.13</td>
<td style="text-align: right;">2.88</td>
<td style="text-align: right;">4.71</td>
<td style="text-align: right;">57.05</td>
</tr>
<tr class="even">
<td style="text-align: left;">kappa</td>
<td style="text-align: right;">-58.66</td>
<td style="text-align: right;">-49.43</td>
<td style="text-align: right;">143.54</td>
<td style="text-align: right;">197.41</td>
<td style="text-align: right;">-265.72</td>
<td style="text-align: right;">165.30</td>
<td style="text-align: right;">2.88</td>
<td style="text-align: right;">4.71</td>
<td style="text-align: right;">57.05</td>
</tr>
<tr class="odd">
<td style="text-align: left;">omega_p</td>
<td style="text-align: right;">0.09</td>
<td style="text-align: right;">0.42</td>
<td style="text-align: right;">0.67</td>
<td style="text-align: right;">0.15</td>
<td style="text-align: right;">-1.13</td>
<td style="text-align: right;">0.63</td>
<td style="text-align: right;">1.61</td>
<td style="text-align: right;">6.86</td>
<td style="text-align: right;">29.53</td>
</tr>
<tr class="even">
<td style="text-align: left;">omega_l</td>
<td style="text-align: right;">-105.40</td>
<td style="text-align: right;">-88.96</td>
<td style="text-align: right;">258.47</td>
<td style="text-align: right;">356.10</td>
<td style="text-align: right;">-477.97</td>
<td style="text-align: right;">297.83</td>
<td style="text-align: right;">2.88</td>
<td style="text-align: right;">4.71</td>
<td style="text-align: right;">57.05</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Evidently, this ruins identification of parameters on the logit (which is not suprising). The posterior is absurdly wide on the logit parameters, and all chains converge very poorly and do not mix well. The question is how this affects the poisson parameters:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb200"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb200-1"><a href="#cb200-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_diagnostics</span>(fit_suppressed_multiple)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[[1]]</code></pre>
</div>
<div class="cell-output-display">
<p><img src="identification_ch1_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
[[2]]</code></pre>
</div>
<div class="cell-output-display">
<p><img src="identification_ch1_files/figure-html/unnamed-chunk-18-2.png" class="img-fluid" width="672"></p>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
[[3]]</code></pre>
</div>
<div class="cell-output-display">
<p><img src="identification_ch1_files/figure-html/unnamed-chunk-18-3.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>The poisson parameters do not vary as wildly, however, the numerical issues on the logit side of course spill into sampling efficiency, as we can see when plotting only poisson parameters:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb204"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb204-1"><a href="#cb204-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(fit_suppressed_multiple<span class="sc">$</span><span class="fu">draws</span>(<span class="at">format=</span><span class="st">"draws_df"</span>) <span class="sc">|&gt;</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(alpha, beta, omega_p)), <span class="at">prob =</span> <span class="fl">0.5</span>) <span class="sc">+</span> <span class="fu">theme_minimal</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Dropping 'draws_df' class as required metadata was removed.</code></pre>
</div>
<div class="cell-output-display">
<p><img src="identification_ch1_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>Here we see the bi-modal peaks that we also saw in our data.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>