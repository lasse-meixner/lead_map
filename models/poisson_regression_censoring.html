<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>BLL poisson regression demonstration</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="poisson_regression_censoring_files/libs/clipboard/clipboard.min.js"></script>
<script src="poisson_regression_censoring_files/libs/quarto-html/quarto.js"></script>
<script src="poisson_regression_censoring_files/libs/quarto-html/popper.min.js"></script>
<script src="poisson_regression_censoring_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="poisson_regression_censoring_files/libs/quarto-html/anchor.min.js"></script>
<link href="poisson_regression_censoring_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="poisson_regression_censoring_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="poisson_regression_censoring_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="poisson_regression_censoring_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="poisson_regression_censoring_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">BLL poisson regression demonstration</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="introduction" class="level1">
<h1>Introduction</h1>
<p>This notebook implements a <a href="https://github.com/fditraglia/learn-bayes/blob/main/censored-data-STAN.qmd">poisson regression</a> example with censored data by running a toy model on data from Massachusetts.</p>
<p>Massachusetts offers itself for this purpose since it does NOT suppress tests, and has a 50% suppression rate.</p>
<p>Since the different tracts have different populations of kids, this will be featured as an offset in the conditional expectation function, as in the example in this other <a href="https://github.com/fditraglia/learn-bayes/blob/main/poisson-regression-STAN.qmd">notebook from learn-bayes</a>.</p>
</section>
<section id="loading-the-data" class="level1">
<h1>Loading the data</h1>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>â”€â”€ Attaching core tidyverse packages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ tidyverse 2.0.0 â”€â”€
âœ” dplyr     1.1.2     âœ” readr     2.1.4
âœ” forcats   1.0.0     âœ” stringr   1.5.0
âœ” ggplot2   3.4.1     âœ” tibble    3.2.1
âœ” lubridate 1.9.2     âœ” tidyr     1.3.0
âœ” purrr     1.0.1     
â”€â”€ Conflicts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ tidyverse_conflicts() â”€â”€
âœ– dplyr::filter() masks stats::filter()
âœ– dplyr::lag()    masks stats::lag()
â„¹ Use the ]8;;http://conflicted.r-lib.org/conflicted package]8;; to force all conflicts to become errors</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"find_and_set_directory.R"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<section id="loading-lead-data" class="level2">
<h2 class="anchored" data-anchor-id="loading-lead-data">Loading Lead Data</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">find_and_set_directory</span>(<span class="st">"source files"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"../00_merging_functions.R"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">load_state</span>(<span class="st">"MA"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "Loading MA from processed_data"</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 16192 Columns: 6
â”€â”€ Column specification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Delimiter: ","
chr (3): state, town, BLL_geq_5
dbl (3): year, tested, tract

â„¹ Use `spec()` to retrieve the full column specification for this data.
â„¹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>ma <span class="ot">&lt;-</span> ma <span class="sc">|&gt;</span> <span class="fu">filter</span>(year <span class="sc">==</span> <span class="dv">2010</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="loading-us-predictors" class="level2">
<h2 class="anchored" data-anchor-id="loading-us-predictors">Loading US predictors</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># load combined_tract.csv from US/predictors/processed_data (otherwise get it from GDrive!)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="fu">find_and_set_directory</span>(<span class="st">"US/predictors/processed_data"</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>ma_predictors <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"combined_tract.csv"</span>) <span class="sc">|&gt;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">grepl</span>(<span class="st">"Massachusetts"</span>, NAME)) <span class="co"># NAME contains Massachusetts</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 95232 Columns: 135
â”€â”€ Column specification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Delimiter: ","
chr  (11): TRACT, NAME, ST, STATE_FIPS, CNTY_FIPS, STCOFIPS, STATE_ABBR, STA...
dbl (124): total_ppl_acs20E, median_annual_incomeE, house_price_medianE, ren...

â„¹ Use `spec()` to retrieve the full column specification for this data.
â„¹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
</div>
</section>
<section id="massachusetts" class="level2">
<h2 class="anchored" data-anchor-id="massachusetts">Massachusetts</h2>
<p>I will first run a toy example with just a single X, and then with a selection of multiple features:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>info_vars <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"TRACT"</span>,<span class="st">"STATE_NAME"</span>,<span class="st">"COUNTY"</span>) </span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>offset_var <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"under_yo5_pplE"</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>features <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"median_annual_incomeE"</span>,<span class="st">"house_price_medianE"</span>,<span class="st">"poor_fam_propE"</span>,<span class="st">"black_ppl_propE"</span>, <span class="st">"bp_pre_1959E_prop"</span>, <span class="st">"svi_socioeconomic_pctile"</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>x_ma <span class="ot">&lt;-</span> ma_predictors <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="fu">all_of</span>(<span class="fu">c</span>(features, offset_var, info_vars))) <span class="sc">|&gt;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># remove any potential duplicate rows from prev. joins</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">distinct</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Merging lead and predictor data at the tract level</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> ma <span class="sc">|&gt;</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">TRACT =</span> tract) <span class="sc">|&gt;</span> </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TRACT =</span> <span class="fu">as.character</span>(TRACT)) <span class="sc">|&gt;</span> </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(x_ma, <span class="at">by =</span> <span class="st">"TRACT"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">censored =</span> <span class="fu">ifelse</span>(<span class="fu">str_detect</span>(BLL_geq_5, <span class="st">"&lt;"</span>), <span class="cn">TRUE</span>, <span class="cn">FALSE</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Concerning the outcome, I am ignoring the fact that the count is upper bounded by the nr of tested. In Massachusetts, this isnâ€™t too bad since testing is so numerous that counts lie way below that bound.</p>
<p>We plot the testing ratio (keeping in mind that kid counts are from 2020, and tests from 2010â€¦)</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sort tracts by under_yo5_pplE and then plot the kid count, the nr of tests, and number of elevations by ordered tract</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>data <span class="sc">%&gt;%</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>censored,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>         under_yo5_pplE<span class="sc">&gt;</span>tested) <span class="sc">%&gt;%</span> <span class="co"># there are some tracts for which this is violated</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(under_yo5_pplE)) <span class="sc">%&gt;%</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">BLL_geq_5 =</span> <span class="fu">as.integer</span>(BLL_geq_5),</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>         <span class="at">tract_factor =</span> <span class="fu">as.character</span>(TRACT),</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">combined_height =</span> under_yo5_pplE <span class="sc">+</span> tested <span class="sc">+</span> BLL_geq_5) <span class="sc">%&gt;%</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tract_factor =</span> <span class="fu">factor</span>(tract_factor, <span class="at">levels =</span> <span class="fu">unique</span>(tract_factor[<span class="fu">order</span>(combined_height, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)]))) <span class="sc">%&gt;%</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> tract_factor)) <span class="sc">+</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">y =</span> under_yo5_pplE, <span class="at">fill =</span> <span class="st">"under_yo5_pplE"</span>), <span class="at">position =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">y =</span> tested, <span class="at">fill =</span> <span class="st">"tested"</span>), <span class="at">position =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>(<span class="fu">aes</span>(<span class="at">y =</span> BLL_geq_5, <span class="at">fill =</span> <span class="st">"BLL_geq_5"</span>), <span class="at">position =</span> <span class="st">"identity"</span>) <span class="sc">+</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Kid count, nr of tests, and nr of elevations by tract in MA"</span>,</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>       <span class="at">x =</span> <span class="st">"Tract"</span>, <span class="at">y =</span> <span class="st">"Count"</span>) <span class="sc">+</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">axis.text.x =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">axis.ticks.x =</span> <span class="fu">element_blank</span>())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="poisson_regression_censoring_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>We can see that testing rates appear quite high.</p>
<p>Note that there is a subset for which CENSUS data on the offset does not agree with the test counts:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>data <span class="sc">|&gt;</span> </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(under_yo5_pplE<span class="sc">&lt;</span>tested) <span class="sc">|&gt;</span> <span class="fu">count</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 Ã— 1
      n
  &lt;int&gt;
1   227</code></pre>
</div>
</div>
<p>We will drop these observations from our stan dataset.</p>
<p>We also plot an overview of the number of kids living in each tract:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot histogram of kids in tracts</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>data <span class="sc">|&gt;</span> </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> under_yo5_pplE)) <span class="sc">+</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_histogram</span>() <span class="sc">+</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Nr. of kids under 5 across tracts in MA"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>`stat_bin()` using `bins = 30`. Pick better value with `binwidth`.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Removed 152 rows containing non-finite values (`stat_bin()`).</code></pre>
</div>
<div class="cell-output-display">
<p><img src="poisson_regression_censoring_files/figure-html/unnamed-chunk-8-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<section id="preparing-the-data" class="level3">
<h3 class="anchored" data-anchor-id="preparing-the-data">Preparing the data</h3>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># drop tracts with NA in X, and remove impossible TRACTs</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(bp_pre_1959E_prop),</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>         under_yo5_pplE <span class="sc">&gt;</span> tested)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="modelling" class="level3">
<h3 class="anchored" data-anchor-id="modelling">Modelling</h3>
<section id="ignoring-censoring-dropping" class="level4">
<h4 class="anchored" data-anchor-id="ignoring-censoring-dropping">Ignoring Censoring (dropping)</h4>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(broom)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co"># running a frequentist poisson regression for uncensored data</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>reg_data <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>censored) <span class="sc">|&gt;</span> </span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">BLL_geq_5 =</span> <span class="fu">as.numeric</span>(BLL_geq_5))</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co"># adding the nr of kids as an exposure parameter</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="fu">glm</span>(BLL_geq_5 <span class="sc">~</span> <span class="fu">scale</span>(bp_pre_1959E_prop) <span class="sc">+</span> <span class="fu">offset</span>(<span class="fu">log</span>(under_yo5_pplE)), <span class="at">data =</span> reg_data, <span class="at">family =</span> <span class="st">"poisson"</span>) <span class="sc">|&gt;</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tidy</span>() <span class="sc">|&gt;</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<thead>
<tr class="header">
<th style="text-align: left;">term</th>
<th style="text-align: right;">estimate</th>
<th style="text-align: right;">std.error</th>
<th style="text-align: right;">statistic</th>
<th style="text-align: right;">p.value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">(Intercept)</td>
<td style="text-align: right;">-4.69</td>
<td style="text-align: right;">0.04</td>
<td style="text-align: right;">-127.77</td>
<td style="text-align: right;">0</td>
</tr>
<tr class="even">
<td style="text-align: left;">scale(bp_pre_1959E_prop)</td>
<td style="text-align: right;">0.96</td>
<td style="text-align: right;">0.03</td>
<td style="text-align: right;">28.96</td>
<td style="text-align: right;">0</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="stan" class="level4">
<h4 class="anchored" data-anchor-id="stan">STAN</h4>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get vectors to pass to stan</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>stan_data <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">N_obs =</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span>censored) <span class="sc">|&gt;</span> <span class="fu">count</span>() <span class="sc">|&gt;</span> <span class="fu">pull</span>(n),</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">N_cens =</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(censored) <span class="sc">|&gt;</span> <span class="fu">count</span>() <span class="sc">|&gt;</span> <span class="fu">pull</span>(n),</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">y_obs =</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span>censored) <span class="sc">|&gt;</span> <span class="fu">pull</span>(BLL_geq_5) <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>(),</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>                  <span class="co"># starting simple with a single X</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>                  <span class="at">x_obs =</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span>censored) <span class="sc">|&gt;</span> <span class="fu">pull</span>(bp_pre_1959E_prop) <span class="sc">|&gt;</span> <span class="fu">scale</span>() <span class="sc">|&gt;</span> <span class="fu">as.vector</span>(),</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>                  <span class="at">x_cens =</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(censored) <span class="sc">|&gt;</span> <span class="fu">pull</span>(bp_pre_1959E_prop) <span class="sc">|&gt;</span> <span class="fu">scale</span>() <span class="sc">|&gt;</span> <span class="fu">as.vector</span>(),</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">kids_obs =</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span>censored) <span class="sc">|&gt;</span> <span class="fu">pull</span>(under_yo5_pplE),</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>                  <span class="at">kids_cens =</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(censored) <span class="sc">|&gt;</span> <span class="fu">pull</span>(under_yo5_pplE),</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ell =</span> <span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import STAN model</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>This is cmdstanr version 0.6.1</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- CmdStanR documentation and vignettes: mc-stan.org/cmdstanr</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- CmdStan path: /Users/lasse/.cmdstan/cmdstan-2.33.0</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- CmdStan version: 2.33.0</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
A newer version of CmdStan is available. See ?install_cmdstan() to install it.
To disable this check set option or environment variable CMDSTANR_NO_VER_CHECK=TRUE.</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>regression_model_one_X <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"poisson_single_X_suppression.stan"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in readLines(stan_file): incomplete final line found on
'poisson_single_X_suppression.stan'</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>regression_model_one_X<span class="sc">$</span><span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>data {
  int&lt;lower=0&gt; N_obs;
  int&lt;lower=0&gt; N_cens;
  array[N_obs] int&lt;lower=0&gt; y_obs; 
  vector[N_obs] x_obs; 
  vector[N_cens] x_cens;
  vector[N_obs] kids_obs;
  vector[N_cens] kids_cens;
  int&lt;lower=0&gt; ell;
}

transformed data {
    vector[N_obs] log_kids_obs = log(kids_obs);
    vector[N_cens] log_kids_cens = log(kids_cens);
}

parameters {
  real alpha;
  real beta;
}

model {
  y_obs ~ poisson_log(log_kids_obs + alpha + beta * x_obs); 
  real mu_j;
  for(j in 1:N_cens) {
    mu_j = exp(log_kids_cens[j] + alpha + beta * x_cens[j]);
    target += log_diff_exp(poisson_lcdf(ell | mu_j), poisson_lpmf(0 | mu_j));
  }
}</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sample </span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> regression_model_one_X<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data,</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">1234</span>,</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>, </span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">parallel_chains =</span> <span class="dv">4</span>,</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">500</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 1 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 2 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 3 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 4 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 1 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 2 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 3 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 1.6 seconds.
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 1.7 seconds.
Chain 2 finished in 1.7 seconds.
Chain 3 finished in 1.7 seconds.

All 4 chains finished successfully.
Mean chain execution time: 1.7 seconds.
Total execution time: 1.8 seconds.</code></pre>
</div>
</div>
</section>
<section id="note-about-initalization" class="level4">
<h4 class="anchored" data-anchor-id="note-about-initalization">Note about initalization</h4>
<p>Before correcting some upstream data issues, in this example the STAN model would not be able to initiate sampling. Even now, it usually takes the algorithm a couple of attempts before HMC gets rolling.</p>
<p>If this happens, the first two things to consider is to check that your data and that it conforms to any logical constraints. The second thing is to consider scaling your predictors in order to bring the parameters closer to a range that STAN will try sampling on: by default this is in [-2,2].</p>
<p>If STAN still has difficulty to initialize, consider trying to grid search initialization values:</p>
<p>This auxiliary wrapper <code>run_init_grid</code> tries initialization of the sampling method for an arbitrarily fine grid of parameter values. I include this just to show how it may be used.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"search_initialization_grid.R"</span>) <span class="co"># imports run_init_grid</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="co"># This will loop over the parameter grid until at least one chain finished successfully.</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>grid_results <span class="ot">&lt;-</span> <span class="fu">run_init_grid</span>(<span class="at">stan_data =</span> stan_data, </span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">stan_model =</span> regression_model_one_X, </span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">param_grid =</span> <span class="fu">list</span>(</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>                <span class="at">alpha =</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="fl">4.6</span>, <span class="sc">-</span><span class="fl">4.4</span>, <span class="fl">0.1</span>), </span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>                <span class="at">beta =</span> <span class="fu">seq</span>(<span class="fl">0.4</span>, <span class="fl">0.8</span>, <span class="fl">0.1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...

Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 1 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 2 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 3 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 4 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 2 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 3 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 4 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 1.7 seconds.
Chain 2 finished in 1.7 seconds.
Chain 3 finished in 1.6 seconds.
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 1.8 seconds.

All 4 chains finished successfully.
Mean chain execution time: 1.7 seconds.
Total execution time: 1.8 seconds.

[1] "Successful initialization for alpha : -4.6"
[2] "Successful initialization for beta : 0.4"  </code></pre>
</div>
</div>
</section>
</section>
<section id="results" class="level3">
<h3 class="anchored" data-anchor-id="results">Results</h3>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a>grid_results<span class="sc">$</span><span class="fu">summary</span>(<span class="at">variables =</span> <span class="fu">c</span>(<span class="st">"lp__"</span>,<span class="st">"alpha"</span>,<span class="st">"beta"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 11%">
<col style="width: 10%">
<col style="width: 7%">
<col style="width: 11%">
<col style="width: 11%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">median</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">mad</th>
<th style="text-align: right;">q5</th>
<th style="text-align: right;">q95</th>
<th style="text-align: right;">rhat</th>
<th style="text-align: right;">ess_bulk</th>
<th style="text-align: right;">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">lp__</td>
<td style="text-align: right;">1397.193</td>
<td style="text-align: right;">1397.480</td>
<td style="text-align: right;">0.961</td>
<td style="text-align: right;">0.726</td>
<td style="text-align: right;">1395.279</td>
<td style="text-align: right;">1398.13</td>
<td style="text-align: right;">1.002</td>
<td style="text-align: right;">1805.590</td>
<td style="text-align: right;">2213.892</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha</td>
<td style="text-align: right;">-4.581</td>
<td style="text-align: right;">-4.581</td>
<td style="text-align: right;">0.025</td>
<td style="text-align: right;">0.024</td>
<td style="text-align: right;">-4.621</td>
<td style="text-align: right;">-4.54</td>
<td style="text-align: right;">1.002</td>
<td style="text-align: right;">1515.056</td>
<td style="text-align: right;">2187.305</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beta</td>
<td style="text-align: right;">0.622</td>
<td style="text-align: right;">0.622</td>
<td style="text-align: right;">0.023</td>
<td style="text-align: right;">0.022</td>
<td style="text-align: right;">0.585</td>
<td style="text-align: right;">0.66</td>
<td style="text-align: right;">1.002</td>
<td style="text-align: right;">1372.024</td>
<td style="text-align: right;">1977.392</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="co"># plot draws from posterior for beta using bayesplot</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesplot)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>This is bayesplot version 1.10.0</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- Online documentation and vignettes at mc-stan.org/bayesplot</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>- bayesplot theme set to bayesplot::theme_default()</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>   * Does _not_ affect other ggplot2 plots</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>   * See ?bayesplot_theme_set for details on theme setting</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mcmc_areas</span>(fit<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="st">"beta"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<p><img src="poisson_regression_censoring_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid" width="672"></p>
</div>
</div>
</section>
</section>
<section id="modelling-with-many-xs" class="level2">
<h2 class="anchored" data-anchor-id="modelling-with-many-xs">Modelling with many Xâ€™s</h2>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co"># drop all NA for any of the features</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>data <span class="ot">&lt;-</span> data <span class="sc">|&gt;</span> </span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">if_all</span>(features, <span class="sc">~</span> <span class="sc">!</span><span class="fu">is.na</span>(.)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Using an external vector in selections was deprecated in tidyselect 1.1.0.
â„¹ Please use `all_of()` or `any_of()` instead.
  # Was:
  data %&gt;% select(features)

  # Now:
  data %&gt;% select(all_of(features))

See &lt;https://tidyselect.r-lib.org/reference/faq-external-vector.html&gt;.</code></pre>
</div>
</div>
<p>To run the regression with multiple Xâ€™s we are changing the types of our inputs to matrices and have to modify the <code>model</code> block.</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>regression_model_many_X <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(<span class="st">"poisson_many_X_suppression.stan"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in readLines(stan_file): incomplete final line found on
'poisson_many_X_suppression.stan'</code></pre>
</div>
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>regression_model_many_X<span class="sc">$</span><span class="fu">print</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>data {
  int&lt;lower=0&gt; N_obs;
  int&lt;lower=0&gt; N_cens;
  int&lt;lower=1&gt; K;
  array[N_obs] int&lt;lower=0&gt; y_obs; 
  matrix[N_obs, K] x_obs; 
  matrix[N_cens, K] x_cens;
  vector[N_obs] kids_obs;
  vector[N_cens] kids_cens;
  int&lt;lower=0&gt; ell;
}

transformed data {
    vector[N_obs] log_kids_obs = log(kids_obs);
    vector[N_cens] log_kids_cens = log(kids_cens);
}

parameters {
  real alpha;
  vector[K] beta;
}

model {
  y_obs ~ poisson_log_glm(x_obs, alpha, beta); 
  real mu_j;
  for(j in 1:N_cens) {
    mu_j = exp(log_kids_cens[j] + alpha + dot_product(beta, x_cens[j])); // Is there a better way to do this?
    target += log_diff_exp(poisson_lcdf(ell | mu_j), poisson_lpmf(0 | mu_j));
  }
}</code></pre>
</div>
</div>
<p>Trying to initialize this with all of the features from our original subselection fails, so we first try with two X to see if the code runs:</p>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="co"># trying two features first:</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>two_features <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"bp_pre_1959E_prop"</span>, <span class="st">"svi_socioeconomic_pctile"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create stan data with all features</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>stan_data_many_X <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">N_obs =</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span>censored) <span class="sc">|&gt;</span> <span class="fu">count</span>() <span class="sc">|&gt;</span> <span class="fu">pull</span>(n),</span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">N_cens =</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(censored) <span class="sc">|&gt;</span> <span class="fu">count</span>() <span class="sc">|&gt;</span> <span class="fu">pull</span>(n),</span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">K =</span> <span class="fu">length</span>(two_features),</span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">y_obs =</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span>censored) <span class="sc">|&gt;</span> <span class="fu">pull</span>(BLL_geq_5) <span class="sc">|&gt;</span> <span class="fu">as.numeric</span>(),</span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>  <span class="co"># starting simple with a single X</span></span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">x_obs =</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span>censored) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="fu">all_of</span>(two_features)) <span class="sc">|&gt;</span> <span class="fu">scale</span>() <span class="sc">|&gt;</span> <span class="fu">as.matrix</span>(),</span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">x_cens =</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(censored) <span class="sc">|&gt;</span> <span class="fu">select</span>(<span class="fu">all_of</span>(two_features)) <span class="sc">|&gt;</span> <span class="fu">scale</span>() <span class="sc">|&gt;</span> <span class="fu">as.matrix</span>(),</span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">kids_obs =</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(<span class="sc">!</span>censored) <span class="sc">|&gt;</span> <span class="fu">pull</span>(under_yo5_pplE),</span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">kids_cens =</span> data <span class="sc">|&gt;</span> <span class="fu">filter</span>(censored) <span class="sc">|&gt;</span> <span class="fu">pull</span>(under_yo5_pplE),</span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">ell =</span> <span class="dv">5</span></span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="co"># sample</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> regression_model_many_X<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> stan_data_many_X,</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">seed =</span> <span class="dv">1234</span>,</span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">chains =</span> <span class="dv">4</span>, </span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">parallel_chains =</span> <span class="dv">4</span>,</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">refresh =</span> <span class="dv">500</span></span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Running MCMC with 4 parallel chains...</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 1   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 1 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 2   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 2 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 3   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 3 Iteration:    1 / 2000 [  0%]  (Warmup) </code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4 Rejecting initial value:</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Log probability evaluates to log(0), i.e. negative infinity.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Chain 4   Stan can't start sampling from this initial value.</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Chain 4 Iteration:    1 / 2000 [  0%]  (Warmup) 
Chain 1 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 2 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 3 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 4 Iteration:  500 / 2000 [ 25%]  (Warmup) 
Chain 1 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 1 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 2 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 2 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 3 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 3 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 4 Iteration: 1000 / 2000 [ 50%]  (Warmup) 
Chain 4 Iteration: 1001 / 2000 [ 50%]  (Sampling) 
Chain 1 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 3 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 2 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 4 Iteration: 1500 / 2000 [ 75%]  (Sampling) 
Chain 1 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 3 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 1 finished in 2.1 seconds.
Chain 3 finished in 2.1 seconds.
Chain 4 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 4 finished in 2.1 seconds.
Chain 2 Iteration: 2000 / 2000 [100%]  (Sampling) 
Chain 2 finished in 2.3 seconds.

All 4 chains finished successfully.
Mean chain execution time: 2.1 seconds.
Total execution time: 2.4 seconds.</code></pre>
</div>
</div>
<div class="cell">
<details>
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb239"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb239-1"><a href="#cb239-1" aria-hidden="true" tabindex="-1"></a>fit<span class="sc">$</span><span class="fu">summary</span>() <span class="sc">|&gt;</span> </span>
<span id="cb239-2"><a href="#cb239-2" aria-hidden="true" tabindex="-1"></a>  knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="at">digits=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<table class="table table-sm table-striped">
<colgroup>
<col style="width: 10%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 7%">
<col style="width: 7%">
<col style="width: 11%">
<col style="width: 11%">
<col style="width: 7%">
<col style="width: 10%">
<col style="width: 10%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">variable</th>
<th style="text-align: right;">mean</th>
<th style="text-align: right;">median</th>
<th style="text-align: right;">sd</th>
<th style="text-align: right;">mad</th>
<th style="text-align: right;">q5</th>
<th style="text-align: right;">q95</th>
<th style="text-align: right;">rhat</th>
<th style="text-align: right;">ess_bulk</th>
<th style="text-align: right;">ess_tail</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">lp__</td>
<td style="text-align: right;">-6417.900</td>
<td style="text-align: right;">-6417.600</td>
<td style="text-align: right;">1.165</td>
<td style="text-align: right;">0.934</td>
<td style="text-align: right;">-6420.171</td>
<td style="text-align: right;">-6416.630</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">1895.408</td>
<td style="text-align: right;">2529.883</td>
</tr>
<tr class="even">
<td style="text-align: left;">alpha</td>
<td style="text-align: right;">-3.966</td>
<td style="text-align: right;">-3.966</td>
<td style="text-align: right;">0.025</td>
<td style="text-align: right;">0.025</td>
<td style="text-align: right;">-4.008</td>
<td style="text-align: right;">-3.928</td>
<td style="text-align: right;">1.002</td>
<td style="text-align: right;">2442.250</td>
<td style="text-align: right;">2410.287</td>
</tr>
<tr class="odd">
<td style="text-align: left;">beta[1]</td>
<td style="text-align: right;">0.526</td>
<td style="text-align: right;">0.526</td>
<td style="text-align: right;">0.022</td>
<td style="text-align: right;">0.022</td>
<td style="text-align: right;">0.490</td>
<td style="text-align: right;">0.562</td>
<td style="text-align: right;">1.001</td>
<td style="text-align: right;">2388.737</td>
<td style="text-align: right;">2218.768</td>
</tr>
<tr class="even">
<td style="text-align: left;">beta[2]</td>
<td style="text-align: right;">0.400</td>
<td style="text-align: right;">0.400</td>
<td style="text-align: right;">0.015</td>
<td style="text-align: right;">0.015</td>
<td style="text-align: right;">0.375</td>
<td style="text-align: right;">0.424</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">2468.720</td>
<td style="text-align: right;">2685.936</td>
</tr>
</tbody>
</table>
</div>
</div>
<pre><code></code></pre>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>